<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta content="origin" name="referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Determine the value of your used car by searching here.">
  <link rel="stylesheet" href="static/CSS/header_style.css"> 
  <link rel="stylesheet" href="static/CSS/body_style.css">
  <link rel="stylesheet" href="static/CSS/image_style.css">  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <title>Car Search</title>
 
  
</head>

<body>

  <div class="topnav">
    <a class="active" href="index.html"><i class="fa fa-fw fa-home"></i>Home</a>
    <a href="https://drive.google.com/file/d/1-BcQM95D8D2jiJPQrcUTpXQF3osbQMGL/view"><i class="fa fa-fw fa-rocket"></i> About</a>
    <a href="https://github.com/colinroberts-data-analytics-portfolio/project4"><i class="fa fa-fw fa-github"></i>Github</a>
    <a href = "contributors.html"><i class="fa fa-fw fa-users"></i>Contributors</a>
    <a href = "tableau_public.html"><i class ="fa fa-fw fa-area-chart"></i>Tableau Public</a>
    <a href = "powerPoint.html"><i class ="fa fa-fw fa-file-powerpoint-o"></i>PowerPoint</a>
  </div>

  <div style="padding-left:16px">
    <h2>How much is your used car worth?</h2>
    <p>Click in the search bar and look up your vehicle.</p>
  </div>
 
  <div class="container">
    <!-- Sidebar for Ads (Left) -->
    <div class="sidebar">
        <p>Ad Space 1</p>
    </div>

    <!-- Main Estimator Form -->
    <div class="main-content">
        <h2>Enter Your Vehicle Information</h2>
            <form id="estimate-form" method="POST" action="/estimate">

                <select id="make" name="make" required>
                    <option value="" disabled selected>Select Make</option>
                  </select>

                <select id="model" name="model" required>
                    <option value="" disabled selected>Select Model</option>
                    <!-- Models will be dynamically inserted here based on the selected Make -->
                </select>
                
                <select id="year" name="year" required>
                    <option value="" disabled selected>Select Year</option>
                </select>
                
                
                <select id="mileage" name="mileage" required>
                    <option value="" disabled selected>Select Mileage Range</option>
                    <option value="0-5000">0 - 5,000 miles</option>
                    <option value="5001-10000">5,001 - 10,000 miles</option>
                    <option value="10001-20000">10,001 - 20,000 miles</option>
                    <option value="20001-50000">20,001 - 50,000 miles</option>
                    <option value="50001-100000">50,001 - 100,000 miles</option>
                    <option value="100001+">100,001+ miles</option>
                </select>
                
                <select id="fuel_type" name="fuel_type" required>
                    <option value="" disabled selected>Select Fuel Type</option>
                </select>
                
                <select id="transmission" name="transmission" required>
                    <option value="" disabled selected>Select Transmission</option>
                </select>
                
                <!-- Submit Button -->
                <button type="submit">Get Estimate</button>
            </form>
            <div id = "results"></div>
        </div>

        <!-- Sidebar for Ads (Right) -->
        <div class="sidebar">
            <p>Ad Space 2</p>
        </div>
    </div>
        
    <div class="search-container">
        <form action="/action_page.php" method="get" aria-label="Search Form">
          <label for="search-make">Make:</label>
          <input type="text" id="search-make" placeholder="e.g. Chevy, Ford, Toyota" required>
          <label for="search-model">Model:</label>
          <input type="text" id="search-model" placeholder="e.g. Silverado, F-150, Tacoma" required>
          <button type="button" onclick="searchImages()">Image Generator</button>
        </form>
    </div> 
</div>
  
<div class="image-container" id="image-container"></div>
  
<script src="static/js/IMG_search.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      const usedCarsCsv = '/resources/used_carswithindex.csv';
      const ratingsCsv = '/resources/ratings_used_cars.csv';

      let usedCarsData = [];
      let ratingsData = [];

      // Function to parse CSV data into JSON
      const parseCSV = (csvText) => {
          const rows = csvText.trim().split('\n').map(row => row.split(','));
          const headers = rows[0].map(header => header.trim());
          
          console.log('CSV Headers:', headers);

          return rows.slice(1).map(row => {
              return headers.reduce((obj, header, index) => {
                  obj[header] = row[index]?.trim() || '';
                  return obj;
              }, {});
          });
      };

      // Function to convert a two-digit year to a four-digit year
      const convertToFourDigitYear = (year) => {
          const currentYear = new Date().getFullYear();
          const century = Math.floor(currentYear / 100) * 100;
          const yearInt = parseInt(year, 10);
          
          if (isNaN(yearInt)) {
              console.warn(`Year is not a number: "${year}"`);
              return NaN;
          }
          
          if (yearInt < 100) {
              return (yearInt < 50) ? (century + yearInt) : (century - 100 + yearInt);
          }
          return yearInt; // Return as is if already four-digit
      };

      // Load CSV data and initialize dropdowns
      const loadData = async () => {
          try {
              const [carsResponse, ratingsResponse] = await Promise.all([
                  fetch(usedCarsCsv),
                  fetch(ratingsCsv)
              ]);
              const carsText = await carsResponse.text();
              const ratingsText = await ratingsResponse.text();
              usedCarsData = parseCSV(carsText);
              ratingsData = parseCSV(ratingsText);
              populateDropdowns();
          } catch (error) {
              console.error('Error loading data:', error);
          }
      };

      // Populate dropdown menus based on available data
      const populateDropdowns = () => {
          const makeSelect = document.getElementById('make');
          const modelSelect = document.getElementById('model');
          const yearSelect = document.getElementById('year');
          const fuelTypeSelect = document.getElementById('fuel_type');
          const transmissionSelect = document.getElementById('transmission');
          
          if (!usedCarsData || usedCarsData.length === 0) {
              console.warn('No data available to populate dropdowns.');
              return;
          }
          
          const makes = new Set();
          const modelsByMake = {};
          const years = new Set();
          const fuelTypes = new Set();
          const transmissions = new Set();
          
          usedCarsData.forEach(car => {
              console.log(`Raw Year Data: ${car['year_made']}`); // Log raw year data

              if (car['Make']) makes.add(car['Make']);
              if (car['Make'] && car['Model']) {
                  if (!modelsByMake[car['Make']]) modelsByMake[car['Make']] = new Set();
                  modelsByMake[car['Make']].add(car['Model']);
              }
              if (car['year_made']) {
                  const trimmedYear = car['year_made'].trim();
                  console.log(`Trimmed Year: "${trimmedYear}"`); // Log trimmed year
                  const year = convertToFourDigitYear(trimmedYear);
                  console.log(`Converted Year: ${year}`); // Log converted year
                  if (!isNaN(year)) {
                      years.add(year);
                  } else {
                      console.warn(`Invalid year value: "${car['year_made']}"`);
                  }
              }
              if (car['fuel_type']) fuelTypes.add(car['fuel_type']);
              if (car['transmission']) transmissions.add(car['transmission']);
          });
          
          const sortedYears = Array.from(years).sort((a, b) => b - a); // Sort years in descending order
          console.log('Sorted Years:', sortedYears);
          
          populateDropdown('make', Array.from(makes));
          populateDropdown('year', sortedYears);
          populateDropdown('fuel_type', Array.from(fuelTypes));
          populateDropdown('transmission', Array.from(transmissions));
          
          makeSelect.addEventListener('change', () => {
              const selectedMake = makeSelect.value;
              populateDropdown('model', []);
              const models = modelsByMake[selectedMake] || [];
              populateDropdown('model', Array.from(models));
          });
      };

      // Populate a dropdown with values
      const populateDropdown = (id, values) => {
          const select = document.getElementById(id);
          select.innerHTML = '<option value="" disabled selected>Select</option>'; // Ensure there's always a default option
          values.forEach(value => {
              const option = document.createElement('option');
              option.value = value;
              option.textContent = value;
              select.appendChild(option);
          });
      };

      // Handle form submission to estimate car price
      document.getElementById('estimate-form').addEventListener('submit', (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData);
          const { make, model, year, mileage, fuel_type, transmission } = data;
          
          // Handle mileage input
          const [minMileage, maxMileage] = mileage.split('-').map(val => val === '100001+' ? 100001 : Number(val));

          // Filter cars based on form data
          let filteredCars = usedCarsData.filter(car => {
              return (
                  car.Make === make &&
                  car.Model === model &&
                  parseFloat(car.year_made) === year &&
                  (mileage === '100001+' ? parseFloat(car.mileage) >= 100001 : (parseFloat(car.mileage) >= minMileage && parseFloat(car.mileage) <= maxMileage)) &&
                  car.fuel_type === fuel_type &&
                  car.transmission === transmission
              );
          });

          // Broaden search if no exact matches
          if (filteredCars.length === 0) {
              filteredCars = usedCarsData.filter(car => {
                  return (
                      car.Make === make &&
                      car.Model === model &&
                      (mileage === '100001+' ? parseFloat(car.mileage) >= 100001 : (parseFloat(car.mileage) >= minMileage - 50000 && parseFloat(car.mileage) <= maxMileage + 50000)) &&
                      car.fuel_type === fuel_type &&
                      car.transmission === transmission
                  );
              });
          }
          if (filteredCars.length === 0) {
              filteredCars = usedCarsData.filter(car => car.Make === make && car.Model === model);
          }
          if (filteredCars.length === 0) {
              filteredCars = usedCarsData.filter(car => car.Make === make);
          }
          if (filteredCars.length === 0) {
              filteredCars = usedCarsData;
          }

          // Calculate estimated price
          const estimatedPrice = filteredCars.length > 0
              ? filteredCars.reduce((sum, car) => sum + parseFloat(car.price), 0) / filteredCars.length
              : 0;

          // Calculate car rating
          const rating = ratingsData.filter(r => r.Make === make && r.Model === model);
          const carRating = rating.length > 0
              ? rating.reduce((sum, r) => sum + parseFloat(r.car_rating), 0) / rating.length
              : 0;

          // Display results
          document.getElementById('results').innerHTML = `
              <h2>Estimated Price: $${estimatedPrice.toFixed(2)}</h2>
              <h3>Car Rating: ${carRating.toFixed(2)}</h3>
          `;
      });

      loadData();
  });
</script>

<footer>
  <p>&copy; 2024 Used Car Estimator. All rights reserved.</p>
</footer>


</body>

</html>
